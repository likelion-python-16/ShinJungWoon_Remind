<button class="social-btn commentToggleBtn"><span class="icon">ğŸ’¬</span><span class="count">${todo.comment_count || 0}</span></button>

<div class="commentBox" style="display:none;">
    <ul class="commentList"></ul>
    <input type="text" class="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">
    <button class="commentSubmit">ë“±ë¡</button>
</div>

<script>    
// ëŒ“ê¸€ ë“±ë¡ ë²„íŠ¼
div.querySelector('.commentSubmit').addEventListener('click', e => {
    e.stopPropagation();
    const commentInput = div.querySelector('.commentInput');
    const content = commentInput.value;
    if (content.trim()) {
        postComment(todo.id, content);
        commentInput.value = '';
    }
});

// ëŒ“ê¸€ í† ê¸€ ë²„íŠ¼
div.querySelector('.commentToggleBtn').addEventListener('click', e => {
    e.stopPropagation();
    const commentBox = div.querySelector('.commentBox');
    commentBox.style.display = (commentBox.style.display === 'none') ? 'block' : 'none';
    loadComments(todo.id, div.querySelector('.commentList'));
});


// ëŒ“ê¸€ ì…ë ¥ì°½ í´ë¦­ ì‹œ, ìƒìœ„ div í´ë¦­ ì´ë²¤íŠ¸(ìƒì„¸í˜ì´ì§€ ì´ë™)ë¥¼ ë§‰ëŠ”ë‹¤
div.querySelector('.commentInput')
    .addEventListener('click', e => e.stopPropagation());


// ëŒ“ê¸€ ë“±ë¡ í•¨ìˆ˜
function postComment(todoId, content) {
  if (!content) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");
  axiosInstance.post("/api/interaction/comments/", { todo_pk: todoId, content: content })
    .then(() => {
      loadComments(todoId, document.querySelector('.commentList'));
    })
    .catch(error => {
      console.error(" ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:", error.response?.data || error);
      alert(" ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:\n" + JSON.stringify(error.response?.data, null, 2));
    });
}

// ëŒ“ê¸€ ëª©ë¡ ë¡œë”© í•¨ìˆ˜
function loadComments(todoId, listElement) {
  axiosInstance.get(`/api/interaction/comments/`, { params: { todo_pk: todoId } })
    .then(res => {
      const payload = Array.isArray(res.data) ? res.data : Array.isArray(res.data.results) ? res.data.results : (res.data.data || []);
      /*
      ìœ„ ì½”ë“œëŠ” ì¡°ê±´ë¬¸ì´ ë‘ ê°œ ì—°ê²°ë˜ì–´ ìˆëŠ” í˜•íƒœ
      if (Array.isArray(res.data)) {
          payload = res.data;
      } else if (Array.isArray(res.data.results)) {
          payload = res.data.results;
      } else {
          payload = res.data.data || [];
      }
      */
      listElement.innerHTML = '';
      payload.forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `${c.user.username || c.username}: ${c.content} 
          <button class="comment-like-btn" data-id="${c.id}">ğŸ‘ ${c.like_count}</button>`;
        li.querySelector('.comment-like-btn')?.addEventListener('click', e => {
          e.stopPropagation();
          toggleCommentLike(c.id);
        });
        listElement.appendChild(li);
      });
    })
    .catch(err => console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', err));
}

// ëŒ“ê¸€ ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜
function toggleCommentLike(commentId) {
  axiosInstance.post(`/api/interaction/commentlikes/${commentId}/toggle/`)
    .then(res => {
      const btn = document.querySelector(`.comment-like-btn[data-id="${commentId}"]`);
      if (btn) btn.innerHTML = `ğŸ‘ ${res.data.like_count}`;
    })
    .catch(err => console.error("ëŒ“ê¸€ ì¢‹ì•„ìš” ì‹¤íŒ¨:", err));
}
</script>